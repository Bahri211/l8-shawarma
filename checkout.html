<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kassen ‚Äì Scandinavian Stenovns Pizza</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet" />
  <script src="https://js.stripe.com/v3/"></script>
  <style>
    body { background: var(--cream); }
    .checkout-page {
      padding: 100px 24px 60px;
      max-width: 1100px; margin: 0 auto;
    }
    .checkout-page h1 {
      font-family: 'Playfair Display', serif;
      font-size: clamp(28px,5vw,44px);
      margin-bottom: 40px; color: var(--dark);
    }
    .checkout-grid {
      display: grid;
      grid-template-columns: 1fr 380px;
      gap: 32px;
    }
    @media(max-width:800px){ .checkout-grid{ grid-template-columns:1fr; } }

    /* LEFT COLUMN */
    .checkout-left { display: flex; flex-direction: column; gap: 24px; }
    .section-card {
      background: var(--white);
      border-radius: var(--radius);
      padding: 28px;
      border: 1.5px solid rgba(212,151,58,.15);
      box-shadow: var(--shadow);
    }
    .section-card h2 {
      font-family: 'Playfair Display', serif;
      font-size: 20px; margin-bottom: 20px; color: var(--dark);
      display: flex; align-items: center; gap: 10px;
    }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media(max-width:480px){ .form-row{ grid-template-columns:1fr; } }

    /* Payment */
    #stripe-element-container {
      background: var(--warm);
      border: 1.5px solid rgba(212,151,58,.2);
      border-radius: 10px;
      padding: 14px 16px;
    }
    #card-errors {
      color: var(--red); font-size: 13px; margin-top: 8px; min-height: 18px;
    }

    /* RIGHT COLUMN ‚Äì order summary */
    .order-summary {
      background: var(--white);
      border-radius: var(--radius);
      padding: 28px;
      border: 1.5px solid rgba(212,151,58,.15);
      box-shadow: var(--shadow);
      position: sticky; top: 90px;
    }
    .order-summary h2 {
      font-family: 'Playfair Display', serif;
      font-size: 20px; margin-bottom: 20px;
    }
    .empty-cart {
      text-align: center; color: var(--muted);
      padding: 32px 0; font-size: 15px;
    }
    .cart-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 0; border-bottom: 1px solid var(--warm);
    }
    .cart-item:last-of-type { border-bottom: none; }
    .ci-name { font-weight: 600; font-size: 15px; }
    .ci-qty { color: var(--muted); font-size: 13px; margin-top: 2px; }
    .ci-price { font-weight: 700; color: var(--red); font-size: 16px; }
    .ci-controls { display: flex; align-items: center; gap: 8px; }
    .qty-btn {
      background: var(--warm); border: none; cursor: pointer;
      width: 28px; height: 28px; border-radius: 50%;
      font-size: 16px; font-weight: 700; display: flex; align-items: center; justify-content: center;
      transition: .15s;
    }
    .qty-btn:hover { background: var(--red); color: var(--white); }
    .summary-divider { border: none; border-top: 1.5px solid var(--warm); margin: 16px 0; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
    .summary-row.total { font-size: 18px; font-weight: 700; color: var(--dark); }
    .summary-row .label { color: var(--muted); }
    .btn-place-order {
      width: 100%; background: var(--red); color: var(--white);
      border: none; cursor: pointer;
      padding: 18px; border-radius: 50px;
      font-size: 17px; font-weight: 700;
      font-family: 'DM Sans', sans-serif;
      margin-top: 20px; transition: .2s;
    }
    .btn-place-order:hover:not(:disabled) { background: var(--red2); transform: translateY(-1px); }
    .btn-place-order:disabled { opacity: .6; cursor: not-allowed; }

    /* Delivery type toggle */
    .delivery-toggle { display: flex; gap: 12px; margin-bottom: 8px; }
    .delivery-opt {
      flex: 1; padding: 12px; border-radius: 12px;
      border: 2px solid rgba(212,151,58,.2);
      text-align: center; cursor: pointer;
      transition: .2s; font-weight: 600; font-size: 14px;
    }
    .delivery-opt.active {
      border-color: var(--red); background: rgba(200,48,43,.06); color: var(--red);
    }

    /* Success overlay */
    .order-success {
      display: none; position: fixed; inset: 0; z-index: 999;
      background: rgba(26,18,9,.75); backdrop-filter: blur(6px);
      align-items: center; justify-content: center;
    }
    .order-success.show { display: flex; }
    .success-card {
      background: var(--white); border-radius: 24px;
      padding: 56px 40px; max-width: 480px; width: 90%;
      text-align: center; box-shadow: var(--shadow-lg);
    }
    .success-icon { font-size: 64px; margin-bottom: 20px; }
    .success-card h2 { font-family: 'Playfair Display', serif; font-size: 32px; margin-bottom: 12px; }
    .success-card p { color: var(--muted); margin-bottom: 8px; }
    .order-id { font-weight: 700; color: var(--red); font-size: 15px; }
    .success-card .btn-primary { margin-top: 28px; display: inline-block; }

    /* ---- DELIVERY MODAL ---- */
    .modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 500;
      background: rgba(26,18,9,.7); backdrop-filter: blur(6px);
      align-items: center; justify-content: center; padding: 24px;
    }
    .modal-overlay.show { display: flex; }
    .delivery-modal {
      background: var(--white); border-radius: 24px;
      width: 100%; max-width: 520px;
      box-shadow: 0 20px 60px rgba(0,0,0,.3);
      overflow: hidden;
    }
    .modal-header {
      background: var(--red); color: var(--white);
      padding: 20px 28px;
      font-family: 'Playfair Display', serif;
      font-size: 20px; font-weight: 700;
      display: flex; align-items: center; justify-content: space-between;
    }
    .modal-close {
      background: none; border: none; color: var(--white);
      font-size: 24px; cursor: pointer; line-height: 1; padding: 0;
    }
    .modal-body { padding: 28px; }

    /* Type buttons */
    .modal-type-btns { display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px; }
    .modal-type-btn {
      padding: 16px; border-radius: 12px; border: none; cursor: pointer;
      font-size: 16px; font-weight: 700; letter-spacing: .05em;
      font-family: 'DM Sans', sans-serif; transition: .2s;
    }
    .modal-type-btn.afhentning {
      background: #4a4a4a; color: var(--white);
    }
    .modal-type-btn.afhentning.selected,
    .modal-type-btn.afhentning:hover {
      background: #2a2a2a;
    }
    .modal-type-btn.levering {
      background: #4a4a4a; color: var(--white);
    }
    .modal-type-btn.levering.selected,
    .modal-type-btn.levering:hover {
      background: var(--red);
    }

    /* Address search */
    .addr-search-wrap {
      display: none; flex-direction: column; gap: 12px;
    }
    .addr-search-wrap.visible { display: flex; }
    .addr-label { font-weight: 600; font-size: 15px; color: var(--dark); }
    .addr-input-row { display: flex; gap: 10px; }
    .addr-input {
      flex: 1; background: var(--warm);
      border: 1.5px solid rgba(212,151,58,.3); border-radius: 10px;
      padding: 13px 15px; font-size: 15px;
      font-family: 'DM Sans', sans-serif; outline: none;
      transition: border-color .2s;
    }
    .addr-input:focus { border-color: var(--red); background: var(--white); }
    .addr-search-btn {
      background: var(--red); color: var(--white);
      border: none; cursor: pointer; padding: 13px 20px;
      border-radius: 10px; font-size: 15px; font-weight: 700;
      font-family: 'DM Sans', sans-serif; transition: .2s; white-space: nowrap;
    }
    .addr-search-btn:hover { background: var(--red2); }
    .addr-search-btn:disabled { opacity: .6; cursor: not-allowed; }

    /* Result box */
    .delivery-result {
      display: none; margin-top: 4px;
      border-radius: 14px; overflow: hidden;
      border: 2px solid #22c55e;
    }
    .delivery-result.show { display: block; }
    .delivery-result.no-delivery { border-color: var(--red); }
    .result-header {
      background: #22c55e; color: var(--white);
      padding: 14px 18px; font-size: 18px; font-weight: 700;
      font-family: 'Playfair Display', serif;
    }
    .delivery-result.no-delivery .result-header { background: var(--red); }
    .result-body { background: #f0fdf4; padding: 16px 18px; }
    .delivery-result.no-delivery .result-body { background: #fff5f5; }
    .result-row {
      display: flex; justify-content: space-between;
      font-size: 14px; padding: 5px 0;
      border-bottom: 1px solid rgba(0,0,0,.06);
      color: var(--text);
    }
    .result-row:last-child { border-bottom: none; }
    .result-row strong { font-weight: 700; }

    /* Confirm buttons */
    .modal-confirm-btns {
      display: none; gap: 12px; margin-top: 20px;
    }
    .modal-confirm-btns.show { display: flex; }
    .btn-nej {
      flex: 1; padding: 14px; border-radius: 50px;
      border: none; cursor: pointer; font-size: 16px; font-weight: 700;
      background: #eab308; color: var(--dark);
      font-family: 'DM Sans', sans-serif; transition: .2s;
    }
    .btn-nej:hover { background: #ca8a04; color: var(--white); }
    .btn-ja {
      flex: 1; padding: 14px; border-radius: 50px;
      border: none; cursor: pointer; font-size: 16px; font-weight: 700;
      background: var(--red); color: var(--white);
      font-family: 'DM Sans', sans-serif; transition: .2s;
    }
    .btn-ja:hover { background: var(--red2); }

    /* Delivery info strip on checkout page */
    .delivery-info-strip {
      display: none; background: #f0fdf4;
      border: 1.5px solid #22c55e; border-radius: 12px;
      padding: 14px 18px; margin-top: 12px;
      font-size: 14px; gap: 8px; flex-direction: column;
    }
    .delivery-info-strip.show { display: flex; }
    .dis-row { display: flex; justify-content: space-between; }
    .dis-change {
      background: none; border: none; color: var(--red);
      font-weight: 600; font-size: 13px; cursor: pointer;
      text-decoration: underline; padding: 0; font-family: 'DM Sans', sans-serif;
    }
  </style>
</head>
<body>

  <nav class="navbar">
    <div class="nav-inner">
      <a class="brand" href="/">
        <span class="brand-icon">üçï</span>
        <span class="brand-text">Scandinavian<br/><em>Stenovns Pizza</em></span>
      </a>
      <a href="/" style="color:var(--muted);text-decoration:none;font-size:14px;">‚Üê Tilbage til menu</a>
    </div>
  </nav>

  <div class="checkout-page">
    <h1>üõí Kassen</h1>

    <div class="checkout-grid">

      <!-- LEFT: DELIVERY + PAYMENT -->
      <div class="checkout-left">

        <!-- Delivery Type -->
        <div class="section-card">
          <h2>üöÄ Leveringstype</h2>
          <div class="delivery-toggle">
            <div class="delivery-opt" id="opt-delivery" onclick="openDeliveryModal('delivery')">üè† Udbringning</div>
            <div class="delivery-opt" id="opt-pickup" onclick="openDeliveryModal('pickup')">üè™ Afhentning</div>
          </div>
          <!-- Delivery confirmed info strip -->
          <div class="delivery-info-strip" id="deliveryInfoStrip">
            <div class="dis-row"><span id="disType" style="font-weight:700;"></span><button class="dis-change" onclick="DeliveryModal.open(function(d){ d.savedAt=Date.now(); localStorage.setItem('sp_delivery', JSON.stringify(d)); applyDeliveryData(d); })">Skift ‚Üí</button></div>
            <div class="dis-row" id="disAddressRow" style="display:none;"><span id="disAddress" style="color:var(--muted);"></span></div>
            <div class="dis-row" id="disDistRow" style="display:none;">
              <span>Afstand: <strong id="disDist"></strong></span>
              <span>Levering: <strong id="disFee" style="color:var(--red);"></strong></span>
            </div>
          </div>
          <p id="pickup-note" style="display:none;color:var(--muted);font-size:13px;margin-top:8px;">
            üìç Bjerrevej 73, 8700 Horsens ‚Äî klar om ca. 20 min
          </p>
        </div>

        <!-- Delivery details -->
        <div class="section-card" id="deliveryFields">
          <h2>üì¶ Leveringsoplysninger</h2>
          <div class="form-group">
            <label>Fulde navn *</label>
            <input class="form-group input" type="text" id="d-name" placeholder="Jens Jensen" style="width:100%;background:var(--warm);border:1.5px solid rgba(212,151,58,.2);border-radius:10px;padding:13px 15px;font-size:15px;font-family:'DM Sans',sans-serif;outline:none;" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Telefon *</label>
              <input type="tel" id="d-phone" placeholder="+45 12 34 56 78" style="width:100%;background:var(--warm);border:1.5px solid rgba(212,151,58,.2);border-radius:10px;padding:13px 15px;font-size:15px;font-family:'DM Sans',sans-serif;outline:none;" />
            </div>
            <div class="form-group">
              <label>E-mail</label>
              <input type="email" id="d-email" placeholder="din@email.dk" style="width:100%;background:var(--warm);border:1.5px solid rgba(212,151,58,.2);border-radius:10px;padding:13px 15px;font-size:15px;font-family:'DM Sans',sans-serif;outline:none;" />
            </div>
          </div>
          <div id="addressFields">
            <div class="form-group" style="margin-top:4px;">
              <label>Adresse *</label>
              <input type="text" id="d-address" placeholder="Eksempelgade 42" style="width:100%;background:var(--warm);border:1.5px solid rgba(212,151,58,.2);border-radius:10px;padding:13px 15px;font-size:15px;font-family:'DM Sans',sans-serif;outline:none;" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>Postnummer</label>
                <input type="text" id="d-zip" placeholder="8700" style="width:100%;background:var(--warm);border:1.5px solid rgba(212,151,58,.2);border-radius:10px;padding:13px 15px;font-size:15px;font-family:'DM Sans',sans-serif;outline:none;" />
              </div>
              <div class="form-group">
                <label>By</label>
                <input type="text" id="d-city" placeholder="Horsens" style="width:100%;background:var(--warm);border:1.5px solid rgba(212,151,58,.2);border-radius:10px;padding:13px 15px;font-size:15px;font-family:'DM Sans',sans-serif;outline:none;" />
              </div>
            </div>
          </div>
          <div class="form-group" style="margin-top:8px;">
            <label>Bem√¶rkninger</label>
            <textarea id="d-notes" placeholder="S√¶rlige √∏nsker, allergier..." rows="2" style="width:100%;background:var(--warm);border:1.5px solid rgba(212,151,58,.2);border-radius:10px;padding:13px 15px;font-size:15px;font-family:'DM Sans',sans-serif;outline:none;resize:vertical;"></textarea>
          </div>
        </div>

        <!-- Payment -->
        <div class="section-card">
          <h2>üí≥ Betaling</h2>
          <p style="color:var(--muted);font-size:14px;margin-bottom:16px;">Sikker betaling via Stripe ‚Äì Vi gemmer ikke kortoplysninger</p>
          <div id="stripe-element-container">
            <!-- Stripe Card Element injected here -->
          </div>
          <div id="card-errors"></div>
          <p style="font-size:12px;color:var(--muted);margin-top:12px;display:flex;align-items:center;gap:6px;">
            üîí Krypteret og sikker betaling
          </p>
        </div>

      </div><!-- /checkout-left -->

      <!-- RIGHT: ORDER SUMMARY -->
      <div class="order-summary">
        <h2>Din Ordre</h2>
        <div id="cartItems"></div>
        <hr class="summary-divider" />
        <div class="summary-row">
          <span class="label">Subtotal</span>
          <span id="subtotal">0 kr</span>
        </div>
        <div class="summary-row" id="deliveryFeeRow">
          <span class="label">Levering</span>
          <span id="deliveryFee">29 kr</span>
        </div>
        <div class="summary-row total">
          <span>Total</span>
          <span id="grandTotal">0 kr</span>
        </div>
        <button class="btn-place-order" id="placeOrderBtn" onclick="placeOrder()">
          Afgiv ordre
        </button>
        <p style="text-align:center;color:var(--muted);font-size:12px;margin-top:12px;">
          Estimeret leveringstid: 25‚Äì40 min
        </p>
      </div>

    </div>
  </div>

  <!-- Success overlay -->
  <div class="order-success" id="orderSuccess">
    <div class="success-card">
      <div class="success-icon">üéâ</div>
      <h2>Tak for din ordre!</h2>
      <p>Din pizza er p√• vej!</p>
      <p class="order-id" id="successOrderId"></p>
      <p style="margin-top:8px;">Estimeret leveringstid: <strong>25‚Äì40 minutter</strong></p>
      <a href="/" class="btn-primary">Tilbage til forsiden</a>
    </div>
  </div>

  <script>
    // ---- CART ----
    let cart = JSON.parse(localStorage.getItem('sp_cart') || '[]');
    let deliveryType = 'delivery';
    let stripe, cardElement;

    function renderCart() {
      const container = document.getElementById('cartItems');
      const btn = document.getElementById('placeOrderBtn');
      if (!cart.length) {
        container.innerHTML = '<div class="empty-cart">üõí Din kurv er tom<br/><a href="/" style="color:var(--red);font-weight:600;">‚Üê G√• til menu og tilf√∏j varer</a></div>';
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.cursor = 'not-allowed';
      } else {
        btn.disabled = false;
        btn.style.opacity = '1';
        btn.style.cursor = 'pointer';
        container.innerHTML = cart.map((item, i) => `
          <div class="cart-item">
            <div>
              <div class="ci-name">${item.name}</div>
              <div class="ci-qty">${item.price} kr √ó ${item.qty}</div>
            </div>
            <div class="ci-controls">
              <button class="qty-btn" onclick="changeQty(${i},-1)">‚àí</button>
              <span style="font-weight:700;min-width:18px;text-align:center;">${item.qty}</span>
              <button class="qty-btn" onclick="changeQty(${i},1)">+</button>
              <span class="ci-price" style="margin-left:8px;">${item.price * item.qty} kr</span>
            </div>
          </div>
        `).join('');
      }
      updateTotals();
    }

    function changeQty(i, delta) {
      cart[i].qty += delta;
      if (cart[i].qty <= 0) cart.splice(i, 1);
      localStorage.setItem('sp_cart', JSON.stringify(cart));
      renderCart();
    }

    function updateTotals() {
      const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
      const fee = deliveryType === 'delivery' ? deliveryFeeAmount : 0;
      const grand = subtotal + fee;
      document.getElementById('subtotal').textContent = subtotal + ' kr';
      document.getElementById('deliveryFee').textContent = fee + ' kr';
      document.getElementById('grandTotal').textContent = grand + ' kr';
    }

    // ---- DELIVERY STATE (managed by delivery-modal.js) ----
    let deliveryFeeAmount = 0;
    let deliveryConfirmed = false;

















    // ---- STRIPE ----
    // Detect if a real Stripe key has been set
    const stripeKey = window.STRIPE_PUBLIC_KEY || 'pk_test_51T4kvT9PpJ5u93penIxhLEJ2qsU9XghVfdzgQcyrNzVtTcGSy9WguAcP1ybdlzDEViWSrk7KLOJOaV1zA1A25LiY00AmbcWElF';
    const stripeReady = stripeKey && !stripeKey.includes('YOUR_PUBLISHABLE_KEY');

    if (stripeReady) {
      try {
        stripe = Stripe(stripeKey);
        const elements = stripe.elements();
        cardElement = elements.create('card', {
          style: {
            base: { fontFamily: "'DM Sans', sans-serif", fontSize: '16px', color: '#2D1F0E', '::placeholder': { color: '#7A6552' } },
            invalid: { color: '#C8302B' }
          }
        });
        cardElement.mount('#stripe-element-container');
        cardElement.on('change', e => {
          document.getElementById('card-errors').textContent = e.error ? e.error.message : '';
        });
        document.getElementById('stripe-element-container').innerHTML = '';
        cardElement.mount('#stripe-element-container');
      } catch(e) {
        console.warn('Stripe init failed:', e);
        showStripeWarning();
      }
    } else {
      // No real key yet ‚Äî show a warning but keep the page usable
      showStripeWarning();
    }

    function showStripeWarning() {
      document.getElementById('stripe-element-container').innerHTML = `
        <div style="background:#fff8e1;border:1.5px solid #f0c040;border-radius:8px;padding:14px 16px;font-size:13px;color:#7a5a00;display:flex;align-items:flex-start;gap:10px;">
          <span style="font-size:18px;">‚ö†Ô∏è</span>
          <div>
            <strong>Stripe ikke konfigureret endnu.</strong><br/>
            Tilf√∏j din <code style="background:rgba(0,0,0,.07);padding:1px 5px;border-radius:4px;">STRIPE_PUBLISHABLE_KEY</code> i <code style="background:rgba(0,0,0,.07);padding:1px 5px;border-radius:4px;">.env.local</code>
            og erstat n√∏glen i <code>checkout.html</code>.<br/>
            <a href="https://dashboard.stripe.com/apikeys" target="_blank" style="color:#c8302b;font-weight:600;">Hent n√∏gler fra Stripe ‚Üí</a>
          </div>
        </div>`;
    }

    // ---- PLACE ORDER ----
    async function placeOrder() {
      const btn = document.getElementById('placeOrderBtn');

      // Validate cart
      if (!cart.length) {
        showError('Din kurv er tom. G√• tilbage og tilf√∏j varer.');
        return;
      }

      // Validate Stripe
      if (!stripeReady || !cardElement) {
        showError('Betalingssystem ikke konfigureret. Tilf√∏j din Stripe n√∏gle.');
        return;
      }

      // Validate delivery fields
      const name    = document.getElementById('d-name').value.trim();
      const phone   = document.getElementById('d-phone').value.trim();
      const address = deliveryType === 'delivery' ? document.getElementById('d-address').value.trim() : 'Afhentning';
      const email   = document.getElementById('d-email').value.trim();
      const notes   = document.getElementById('d-notes').value.trim();
      const zip     = document.getElementById('d-zip')?.value?.trim() || '';
      const city    = document.getElementById('d-city')?.value?.trim() || '';

      if (!name) { showError('Udfyld venligst dit fulde navn.'); return; }
      if (!phone) { showError('Udfyld venligst dit telefonnummer.'); return; }
      if (deliveryType === 'delivery' && !address) { showError('Udfyld venligst din leveringsadresse.'); return; }

      btn.textContent = '‚è≥ Behandler betaling...';
      btn.disabled = true;
      clearError();

      const subtotal = cart.reduce((s, i) => s + i.price * i.qty, 0);
      const fee = deliveryType === 'delivery' ? deliveryFeeAmount : 0;
      const total = subtotal + fee;

      try {
        // 1. Create Payment Intent on backend
        const intentRes = await fetch('/api/payment/intent', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount: total, currency: 'dkk' })
        });
        const intentData = await intentRes.json();
        if (!intentRes.ok) throw new Error(intentData.error || 'Betaling fejlede.');

        // 2. Confirm card payment with Stripe
        const { error, paymentIntent } = await stripe.confirmCardPayment(intentData.clientSecret, {
          payment_method: {
            card: cardElement,
            billing_details: { name, email: email || undefined, phone }
          }
        });
        if (error) throw new Error(error.message);

        // 3. Save confirmed order to backend
        const orderRes = await fetch('/api/payment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            delivery: { name, phone, email, address, zip, city, notes, type: deliveryType },
            items: cart,
            totalAmount: total,
            paymentIntentId: paymentIntent.id,
            paymentMethod: 'card'
          })
        });
        const orderData = await orderRes.json();
        if (!orderRes.ok) throw new Error(orderData.error || 'Ordre fejlede.');

        // 4. SUCCESS ‚Äî clear cart and show confirmation
        localStorage.removeItem('sp_cart');
        document.getElementById('successOrderId').textContent = 'Ordre ID: ' + orderData.order.orderId;
        document.getElementById('orderSuccess').classList.add('show');

      } catch (err) {
        showError('‚ùå ' + err.message);
        btn.textContent = 'Afgiv ordre';
        btn.disabled = false;
      }
    }

    // ---- HELPERS ----
    function showError(msg) {
      let el = document.getElementById('checkoutError');
      if (!el) {
        el = document.createElement('div');
        el.id = 'checkoutError';
        el.style.cssText = 'background:rgba(200,48,43,.08);border:1.5px solid rgba(200,48,43,.3);color:#C8302B;padding:14px 18px;border-radius:12px;font-size:14px;font-weight:500;margin-bottom:16px;';
        document.getElementById('placeOrderBtn').insertAdjacentElement('beforebegin', el);
      }
      el.textContent = msg;
      el.style.display = 'block';
      el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
    function clearError() {
      const el = document.getElementById('checkoutError');
      if (el) el.style.display = 'none';
    }

    // ---- PRE-FILL FROM sp_delivery (set on homepage) ----
    (function prefillDelivery() {
      const saved = localStorage.getItem('sp_delivery');
      if (!saved) {
        setTimeout(() => DeliveryModal.open(function(d) {
          localStorage.setItem('sp_delivery', JSON.stringify(d));
          applyDeliveryData(d);
        }), 400);
        return;
      }
      try {
        const data = JSON.parse(saved);
        // Check if saved data is fresh (less than 2 hours old)
        const savedTime = data.savedAt || 0;
        const twoHours = 2 * 60 * 60 * 1000;
        if (Date.now() - savedTime > twoHours) {
          // Stale ‚Äî clear and ask again
          localStorage.removeItem('sp_delivery');
          setTimeout(() => DeliveryModal.open(function(d) {
            localStorage.setItem('sp_delivery', JSON.stringify(d));
            applyDeliveryData(d);
          }), 400);
          return;
        }
        applyDeliveryData(data);
      } catch(e) {
        localStorage.removeItem('sp_delivery');
        setTimeout(() => DeliveryModal.open(function(d) {
          localStorage.setItem('sp_delivery', JSON.stringify(d));
          applyDeliveryData(d);
        }), 400);
      }
    })();

    function applyDeliveryData(data) {
      if (!data) return;
      deliveryType = data.type;
      deliveryFeeAmount = data.fee || 0;
      deliveryConfirmed = true;

      // Update toggle buttons
      document.getElementById('opt-delivery').classList.toggle('active', data.type === 'delivery');
      document.getElementById('opt-pickup').classList.toggle('active', data.type === 'pickup');

      if (data.type === 'delivery') {
        document.getElementById('addressFields').style.display = '';
        document.getElementById('deliveryFeeRow').style.display = '';
        document.getElementById('pickup-note').style.display = 'none';
        if (data.address) document.getElementById('d-address').value = data.address;

        // Show info strip
        const strip = document.getElementById('deliveryInfoStrip');
        strip.classList.add('show');
        document.getElementById('disType').textContent = 'üè† Udbringning';
        if (data.address) {
          document.getElementById('disAddress').textContent = data.address;
          document.getElementById('disAddressRow').style.display = '';
        }
        if (data.distanceText) {
          document.getElementById('disDist').textContent = data.distanceText;
          document.getElementById('disFee').textContent = (data.fee || 0) + ' kr';
          document.getElementById('disDistRow').style.display = '';
        }
      } else {
        document.getElementById('addressFields').style.display = 'none';
        document.getElementById('deliveryFeeRow').style.display = 'none';
        document.getElementById('pickup-note').style.display = '';
        const strip = document.getElementById('deliveryInfoStrip');
        strip.classList.add('show');
        document.getElementById('disType').textContent = 'üè™ Afhentning ‚Äì Bjerrevej 73, 8700 Horsens';
        document.getElementById('disAddressRow').style.display = 'none';
        document.getElementById('disDistRow').style.display = 'none';
      }
      updateTotals();
    }

    // Init
    renderCart();
  </script>

  <script src="delivery-modal.js"></script>
</body>
</html>